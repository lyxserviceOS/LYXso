"use client";

import React, { useState, useEffect } from "react";
import { getApiBaseUrl } from "@/lib/apiConfig";

const API_BASE_URL = getApiBaseUrl();
const ORG_ID = process.env.NEXT_PUBLIC_ORG_ID;

if (!ORG_ID) {
  console.warn(
    "[PublicBookingPageClient] NEXT_PUBLIC_ORG_ID mangler ‚Äì public booking vil feile."
  );
}

type Service = {
  id: string;
  name: string;
  description: string | null;
  duration_minutes: number;
  price: number | null;
  currency: string | null;
};

type OrgInfo = {
  id: string;
  name: string;
  slug: string;
  logo_url: string | null;
  booking_settings: {
    allow_auto_booking?: boolean;
    show_available_slots?: boolean;
    booking_slot_duration_minutes?: number;
    min_booking_lead_hours?: number;
    max_booking_lead_days?: number;
  } | null;
};

type AvailableSlot = {
  start: string; // ISO string
  end: string; // ISO string
  available: boolean;
  time: string; // HH:MM display format
};

type PublicBookingForm = {
  customerName: string;
  customerEmail: string;
  customerPhone: string;
  serviceId: string;
  serviceName: string;
  startTime: string; // ISO string
  endTime: string; // ISO string
  notes: string;
};

const EMPTY_FORM: PublicBookingForm = {
  customerName: "",
  customerEmail: "",
  customerPhone: "",
  serviceId: "",
  serviceName: "",
  startTime: "",
  endTime: "",
  notes: "",
};

export default function PublicBookingPageClient() {
  // Org & Services
  const [orgInfo, setOrgInfo] = useState<OrgInfo | null>(null);
  const [services, setServices] = useState<Service[]>([]);
  const [loadingOrg, setLoadingOrg] = useState(true);
  const [loadingServices, setLoadingServices] = useState(false);
  
  // Booking form
  const [form, setForm] = useState<PublicBookingForm>(EMPTY_FORM);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  
  // Slot selection
  const [bookingMode, setBookingMode] = useState<"slots" | "manual">("slots");
  const [selectedDate, setSelectedDate] = useState<string>("");
  const [availableSlots, setAvailableSlots] = useState<AvailableSlot[]>([]);
  const [loadingSlots, setLoadingSlots] = useState(false);
  const [selectedSlot, setSelectedSlot] = useState<AvailableSlot | null>(null);

  // Load org info and services on mount
  useEffect(() => {
    if (!ORG_ID) return;
    loadOrgInfo();
    loadServices();
  }, []);

  // Load slots when date or service changes
  useEffect(() => {
    if (selectedDate && form.serviceId && bookingMode === "slots") {
      loadAvailableSlots();
    }
  }, [selectedDate, form.serviceId, bookingMode]);

  async function loadOrgInfo() {
    setLoadingOrg(true);
    setError(null);
    
    try {
      const res = await fetch(`${API_BASE_URL}/api/orgs/${ORG_ID}/settings`);
      if (!res.ok) throw new Error(`Failed to load org info: ${res.status}`);
      
      const data = await res.json();
      const org = data.org as OrgInfo;
      
      setOrgInfo(org);
      
      // Set booking mode based on org settings
      if (org.booking_settings?.show_available_slots !== false) {
        setBookingMode("slots");
      } else {
        setBookingMode("manual");
      }
    } catch (err) {
      console.error("[PublicBooking] Error loading org info:", err);
      setError("Kunne ikke laste organisasjonsinformasjon");
    } finally {
      setLoadingOrg(false);
    }
  }

  async function loadServices() {
    if (!ORG_ID) return;
    
    setLoadingServices(true);
    try {
      const res = await fetch(`${API_BASE_URL}/api/orgs/${ORG_ID}/services`);
      if (!res.ok) throw new Error(`Failed to load services: ${res.status}`);
      
      const data = await res.json();
      setServices(data.services || []);
    } catch (err) {
      console.error("[PublicBooking] Error loading services:", err);
    } finally {
      setLoadingServices(false);
    }
  }

  async function loadAvailableSlots() {
    if (!ORG_ID || !selectedDate) return;
    
    setLoadingSlots(true);
    setError(null);
    
    try {
      const selectedService = services.find(s => s.id === form.serviceId);
      const duration = selectedService?.duration_minutes || 60;
      
      const params = new URLSearchParams({
        date: selectedDate,
        duration_minutes: duration.toString(),
      });
      
      if (form.serviceId) {
        params.append('service_id', form.serviceId);
      }
      
      const res = await fetch(
        `${API_BASE_URL}/api/public/orgs/${ORG_ID}/availability?${params}`
      );
      
      if (!res.ok) {
        throw new Error(`Failed to load availability: ${res.status}`);
      }
      
      const data = await res.json();
      setAvailableSlots(data.slots || []);
    } catch (err) {
      console.error("[PublicBooking] Error loading slots:", err);
      setError("Kunne ikke laste ledige tider");
      setAvailableSlots([]);
    } finally {
      setLoadingSlots(false);
    }
  }

  function handleSelectService(serviceId: string) {
    const service = services.find(s => s.id === serviceId);
    if (!service) return;
    
    setForm(prev => ({
      ...prev,
      serviceId: service.id,
      serviceName: service.name,
    }));
    
    // Reset slot selection when service changes
    setSelectedSlot(null);
    setAvailableSlots([]);
  }
  
  function handleSelectSlot(slot: AvailableSlot) {
    if (!slot.available) return;
    
    setSelectedSlot(slot);
    setForm(prev => ({
      ...prev,
      startTime: slot.start,
      endTime: slot.end,
    }));
  }

  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    setError(null);
    setSuccessMessage(null);

    if (!ORG_ID) {
      setError("Systemfeil: organisasjon mangler i oppsett.");
      return;
    }

    const trimmedName = form.customerName.trim();
    const trimmedEmail = form.customerEmail.trim();
    const trimmedPhone = form.customerPhone.trim();

    if (!trimmedName) {
      setError("Navn m√• fylles ut.");
      return;
    }
    if (!trimmedEmail) {
      setError("E-post m√• fylles ut.");
      return;
    }
    if (!form.serviceId) {
      setError("Tjeneste m√• velges.");
      return;
    }
    if (!form.startTime) {
      setError("Tidspunkt m√• velges.");
      return;
    }

    setSubmitting(true);
    try {
      const selectedService = services.find(s => s.id === form.serviceId);
      const duration = selectedService?.duration_minutes || 60;

      const payload = {
        service_id: form.serviceId,
        starts_at: form.startTime,
        duration_minutes: duration,
        customer_name: trimmedName,
        customer_email: trimmedEmail,
        customer_phone: trimmedPhone || null,
        notes: form.notes.trim() || null,
        recaptcha_token: "dummy_token_for_dev", // TODO: Implement real reCAPTCHA
      };

      const res = await fetch(
        `${API_BASE_URL}/api/public/orgs/${ORG_ID}/bookings`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) {
        const errData = await res.json();
        setError(errData.details || errData.error || "Kunne ikke opprette booking");
        return;
      }

      setForm(EMPTY_FORM);
      setSelectedSlot(null);
      setSelectedDate("");
      setSuccessMessage(
        "Takk! Din booking er mottatt. Du vil f√• bekreftelse p√• e-post s√• snart den er behandlet."
      );
    } catch (err) {
      console.error("[PublicBooking] Submit error:", err);
      setError("Noe gikk galt. Vennligst pr√∏v igjen senere.");
    } finally {
      setSubmitting(false);
    }
  }

  // Get available dates (next 14 days, excluding past dates)
  const getAvailableDates = () => {
    const dates = [];
    const now = new Date();
    const minBookingTime = orgInfo?.booking_settings?.min_booking_lead_hours || 2;
    const maxBookingDays = orgInfo?.booking_settings?.max_booking_lead_days || 30;
    
    for (let i = 0; i < maxBookingDays; i++) {
      const date = new Date(now);
      date.setDate(date.getDate() + i);
      
      // Check if date is far enough in future
      const minDate = new Date(now.getTime() + minBookingTime * 60 * 60 * 1000);
      if (date >= minDate) {
        dates.push(date.toISOString().split('T')[0]);
      }
    }
    
    return dates;
  };

  const availableDates = getAvailableDates();

  if (loadingOrg) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <div className="text-center">
          <div className="mb-4 h-12 w-12 animate-spin rounded-full border-4 border-blue-600 border-t-transparent mx-auto" />
          <p className="text-slate-600">Laster booking-system...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto flex min-h-screen max-w-4xl flex-col px-4 py-10">
      <header className="mb-8 text-center">
        {orgInfo?.logo_url && (
          <img 
            src={orgInfo.logo_url} 
            alt={orgInfo.name}
            className="mx-auto mb-4 h-16 object-contain"
          />
        )}
        <h1 className="text-3xl font-bold text-slate-900">
          {orgInfo?.name || "Book time"}
        </h1>
        <p className="mt-2 text-slate-600">
          Velg tjeneste og √∏nsket tidspunkt
        </p>
      </header>
        <h1 className="mt-2 text-2xl font-semibold text-slate-900">
          Bestill time
        </h1>
        <p className="mt-1 text-sm text-slate-600">
          Fyll inn √∏nsket tidspunkt og kontaktinformasjon, s√• bekrefter vi
          bookingen s√• fort som mulig.
        </p>
      </header>

      <main className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">

      {/* Success message */}
      {successMessage && (
        <div className="mb-8 rounded-lg border border-green-200 bg-green-50 p-4">
          <div className="flex items-start gap-3">
            <svg className="h-5 w-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              <p className="font-medium text-green-900">{successMessage}</p>
            </div>
          </div>
        </div>
      )}

      {/* Error message */}
      {error && (
        <div className="mb-8 rounded-lg border border-red-200 bg-red-50 p-4">
          <div className="flex items-start gap-3">
            <svg className="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              <p className="font-medium text-red-900">{error}</p>
            </div>
          </div>
        </div>
      )}

      <form onSubmit={handleSubmit} className="space-y-8">
        {/* Step 1: Select Service */}
        <div className="rounded-lg border border-slate-200 bg-white p-6">
          <h2 className="mb-4 text-lg font-semibold text-slate-900">
            1. Velg tjeneste
          </h2>
          
          {loadingServices ? (
            <div className="py-8 text-center text-slate-500">
              Laster tjenester...
            </div>
          ) : services.length === 0 ? (
            <div className="py-8 text-center text-slate-500">
              Ingen tjenester tilgjengelig for √∏yeblikket.
            </div>
          ) : (
            <div className="grid gap-3 md:grid-cols-2">
              {services.map((service) => (
                <button
                  key={service.id}
                  type="button"
                  onClick={() => handleSelectService(service.id)}
                  className={`rounded-lg border-2 p-4 text-left transition-all ${
                    form.serviceId === service.id
                      ? "border-blue-600 bg-blue-50"
                      : "border-slate-200 bg-white hover:border-slate-300"
                  }`}
                >
                  <div className="font-medium text-slate-900">{service.name}</div>
                  {service.description && (
                    <div className="mt-1 text-sm text-slate-600">
                      {service.description}
                    </div>
                  )}
                  <div className="mt-2 flex items-center gap-4 text-xs text-slate-500">
                    <span>‚è±Ô∏è {service.duration_minutes} min</span>
                    {service.price && (
                      <span>
                        üí∞ {service.price} {service.currency || "NOK"}
                      </span>
                    )}
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>

        {/* Step 2: Select Date & Time */}
        {form.serviceId && bookingMode === "slots" && (
          <div className="rounded-lg border border-slate-200 bg-white p-6">
            <h2 className="mb-4 text-lg font-semibold text-slate-900">
              2. Velg dato og tidspunkt
            </h2>
            
            {/* Date selection */}
            <div className="mb-6">
              <label className="mb-2 block text-sm font-medium text-slate-700">
                Velg dato
              </label>
              <select
                value={selectedDate}
                onChange={(e) => setSelectedDate(e.target.value)}
                className="w-full rounded-lg border border-slate-300 px-4 py-2"
              >
                <option value="">-- Velg dato --</option>
                {availableDates.map((date) => (
                  <option key={date} value={date}>
                    {new Date(date).toLocaleDateString('nb-NO', {
                      weekday: 'long',
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </option>
                ))}
              </select>
            </div>

            {/* Time slots */}
            {selectedDate && (
              <div>
                <label className="mb-2 block text-sm font-medium text-slate-700">
                  Ledige tider
                </label>
                
                {loadingSlots ? (
                  <div className="py-8 text-center text-slate-500">
                    Laster ledige tider...
                  </div>
                ) : availableSlots.length === 0 ? (
                  <div className="rounded-lg border border-amber-200 bg-amber-50 p-4 text-sm text-amber-800">
                    Ingen ledige tider denne dagen. Pr√∏v en annen dato.
                  </div>
                ) : (
                  <div className="grid grid-cols-3 gap-2 md:grid-cols-4 lg:grid-cols-6">
                    {availableSlots.map((slot, idx) => (
                      <button
                        key={idx}
                        type="button"
                        onClick={() => handleSelectSlot(slot)}
                        disabled={!slot.available}
                        className={`rounded-lg border-2 px-3 py-2 text-sm font-medium transition-all ${
                          selectedSlot?.start === slot.start
                            ? "border-blue-600 bg-blue-600 text-white"
                            : slot.available
                            ? "border-slate-200 bg-white text-slate-700 hover:border-blue-300 hover:bg-blue-50"
                            : "border-slate-100 bg-slate-50 text-slate-400 cursor-not-allowed line-through"
                        }`}
                      >
                        {slot.time}
                      </button>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {/* Step 3: Customer Information */}
        {form.startTime && (
          <div className="rounded-lg border border-slate-200 bg-white p-6">
            <h2 className="mb-4 text-lg font-semibold text-slate-900">
              3. Din informasjon
            </h2>
            
            <div className="space-y-4">
              <div className="grid gap-4 md:grid-cols-2">
                <div>
                  <label className="mb-1 block text-sm font-medium text-slate-700">
                    Navn *
                  </label>
                  <input
                    type="text"
                    required
                    className="w-full rounded-lg border border-slate-300 px-4 py-2"
                    value={form.customerName}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, customerName: e.target.value }))
                    }
                    placeholder="Ditt fulle navn"
                  />
                </div>
                <div>
                  <label className="mb-1 block text-sm font-medium text-slate-700">
                    E-post *
                  </label>
                  <input
                    type="email"
                    required
                    className="w-full rounded-lg border border-slate-300 px-4 py-2"
                    value={form.customerEmail}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, customerEmail: e.target.value }))
                    }
                    placeholder="din@epost.no"
                  />
                </div>
              </div>

              <div>
                <label className="mb-1 block text-sm font-medium text-slate-700">
                  Telefon (valgfritt)
                </label>
                <input
                  type="tel"
                  className="w-full rounded-lg border border-slate-300 px-4 py-2"
                  value={form.customerPhone}
                  onChange={(e) =>
                    setForm((prev) => ({ ...prev, customerPhone: e.target.value }))
                  }
                  placeholder="Ditt telefonnummer"
                />
              </div>

              <div>
                <label className="mb-1 block text-sm font-medium text-slate-700">
                  Kommentar (valgfritt)
                </label>
                <textarea
                  className="w-full rounded-lg border border-slate-300 px-4 py-2"
                  rows={4}
                  value={form.notes}
                  onChange={(e) =>
                    setForm((prev) => ({ ...prev, notes: e.target.value }))
                  }
                  placeholder="Ekstra informasjon, spesielle √∏nsker, etc."
                />
              </div>
            </div>
          </div>
        )}

        {/* Submit */}
        {form.startTime && (
          <div className="flex justify-end gap-3">
            <button
              type="button"
              onClick={() => {
                setForm(EMPTY_FORM);
                setSelectedSlot(null);
                setSelectedDate("");
              }}
              className="rounded-lg border border-slate-300 px-6 py-2.5 font-medium text-slate-700 hover:bg-slate-50"
            >
              Avbryt
            </button>
            <button
              type="submit"
              disabled={submitting}
              className="rounded-lg bg-blue-600 px-6 py-2.5 font-medium text-white hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed"
            >
              {submitting ? "Sender..." : "Bekreft booking"}
            </button>
          </div>
        )}
      </form>
            />
          </div>

          <div className="mt-4 flex items-center justify-end">
            <button
              type="submit"
              disabled={submitting}
              className="rounded-full bg-slate-900 px-5 py-2 text-xs font-medium text-slate-50 hover:bg-slate-800 disabled:opacity-60"
            >
              {submitting ? "Sender ‚Ä¶" : "Send foresp√∏rsel"}
            </button>
          </div>
        </form>
      </main>

      <footer className="mt-6 text-center text-[11px] text-slate-400">
        Foresp√∏rselen blir lagret som{" "}
        <span className="font-medium">‚Äúpending‚Äù</span> booking i systemet, og
        dere kan bekrefte den i intern bookingkalender.
      </footer>
    </div>
  );
}
